<!DOCTYPE html><html class="no-js" lang="en"><head><!--[if lte IE 9]>
  <meta http-equiv="refresh" content="0;url=https://ntpntp1997.github.io/warn.html" />
<![endif]--><meta charset="utf-8"><meta http-equiv="X-DNS-Prefetch-Control" content="on"><link rel="dns-prefetch" href="https://ntpntp1997.github.io"><link rel="alternate" href="https://ntpntp1997.github.io" hreflang="en-US"><link rel="dns-prefetch" href="//www.google-analytics.com"><link rel="prefetch" href="https://ntpntp1997.github.io"><link rel="canonical" href="https://ntpntp1997.github.io/huong-dan-xay-dung-grpc-server-bang-typescript-don-gian/"><link rel="prefetch" href="//www.google-analytics.com"><link rel="amphtml" href="https://ntpntp1997.github.io/Huong-dan-xay-dung-gRPC-server-bang-typescript-don-gian//amp/index.html"><link rel="prerender" href="https://ntpntp1997.github.io"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="renderer" content="webkit"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta http-equiv="mobile-agent" content="format=html5; url=https://ntpntp1997.github.io"><meta name="author" content="Thanh Phuong"><link rel="stylesheet" href="/css/JSimple.css"><link rel="shortcut icon" href="/images/favicon.png"><title>Hướng dẫn xây dựng gRPC server bằng typescript đơn giản - Blog Developer</title><meta name="keywords" content="gRPC, typescript, protobuf, nodejs"><meta name="description " content="Hexo được tạo ra bằng Node.js và với mục đích chính dùng cho trang blog. Giống với rất nhiều static site generators khác, bạn cũng sẽ soạn thảo nội dung với markdown. Template mặc định được Hexo sử dụng chính là Swig. Swig không còn xa lạ gì đối với một lập trình viên JS. Tuy nhiên bạn cũng có thể sử dụng một template engine khác nếu muốn, Hexo cho phép bạn làm được điều này. So với Jekyll hoặc Hugo thì Hexo có đôi chút phức tạp hơn."><meta property="og:title" content="Hướng dẫn xây dựng gRPC server bằng typescript đơn giản - Blog Developer"><meta property="og:url" content="https://ntpntp1997.github.io/Huong-dan-xay-dung-gRPC-server-bang-typescript-don-gian/"><meta property="og:type" content="website"><meta property="fb:app_id" content="1312420762290725"><meta property="og:description" content="Hexo được tạo ra bằng Node.js và với mục đích chính dùng cho trang blog. Giống với rất nhiều static site generators khác, bạn cũng sẽ soạn thảo nội dung với markdown. Template mặc định được Hexo sử dụng chính là Swig. Swig không còn xa lạ gì đối với một lập trình viên JS. Tuy nhiên bạn cũng có thể sử dụng một template engine khác nếu muốn, Hexo cho phép bạn làm được điều này. So với Jekyll hoặc Hugo thì Hexo có đôi chút phức tạp hơn."><meta property="og:image" content="/images/gRPC.png"><script data-ad-client="ca-pub-8405511385846799" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script async src="//www.googletagmanager.com/gtag/js?id=UA-164523547-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-164523547-1")</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="nav"><nav class="nav-menu"><a class="site-name current" href="/" title="Blog">Blog</a> <a class="site-index current" href="/"><i class="fa fa-home"></i><span>Home</span></a> <a href="/archives" title="Archives"><i class="fa fa-archives"></i><span>Archives</span></a> <a href="/tags" title="Tags"><i class="fa fa-tags"></i><span>Tags</span></a><a href="/categories" title="Categories"><i class="fa fa-th-large"></i> <span>Categories</span> </a><a href="/categories/Framework/" title="Framework"><i class="fa fa-file-code-o"></i> <span>Framework</span> </a><a href="/categories/Developer/" title="Developer"><i class="fa fa-suitcase"></i> <span>Developer</span></a></nav></div><div class="nav-user"><a class="btn-search" href="#"><i class="fa fa-search"></i></a> <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a></div><div id="wrapper" class="clearfix"><div id="body"><div class="main" id="main"><div id="cover"><div class="cover-img"></div><div class="cover-info"><h1 class="cover-siteName">Blog IT</h1><h3 class="cover-siteTitle">Rock the world with code</h3><p class="cover-siteDesc">An IT blog focused on technology and humanities</p><div class="cover-sns">&nbsp;&nbsp;<div class="btn btn-instagram"><a href="https://www.instagram.com/ntpntp10081997" rel="external nofollow noreferrer" target="_blank" title="instagram" ref="friend"><i class="fa fa-instagram"></i></a></div>&nbsp;&nbsp;<div class="btn btn-facebook"><a href="https://www.facebook.com/nguyenthanhphuong.ntp" rel="external nofollow noreferrer" target="_blank" title="facebook" ref="friend"><i class="fa fa-facebook"></i></a></div>&nbsp;&nbsp;<div class="btn btn-github"><a href="https://github.com/ntpntp1997" rel="external nofollow noreferrer" target="_blank" title="github" ref="friend"><i class="fa fa-github"></i></a></div></div></div></div><div class="page-title"><ul><li><a href="/">Recent Posts</a></li><li><a href="/categories/Framework" data-name="Linh Tinh">Linh Tinh</a></li><li class="page-search"><form id="search" class="search-form"><input type="text" readonly id="local-search-input-tip" placeholder="click to search..."> <button type="button" disabled class="search-form-submit"><i class="fa fa-search"></i></button></form></li></ul></div><div class="main-inner"><div id="fb-root"></div><script>!function(e,t,o){var n,r=e.getElementsByTagName(t)[0];e.getElementById(o)||((n=e.createElement(t)).id=o,n.src="//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.1&appId=1312420762290725&autoLogAppEvents=1&colorscheme=dark&order_by=time",r.parentNode.insertBefore(n,r))}(document,"script","facebook-jssdk")</script><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><div class="post-header"><div class="post-banner-header"><img src="/images/gRPC.png" alt="thumnail"></div><div class="post-author clearfix"><a class="avatar fleft" href="/" target="_blank"><img width="48" src="/images/72136068_1409316392553400_5411734414449180672_n.jpg" alt="avatar"></a><p><span class="label">Author</span> <a href="/" target="_blank">Thanh Phương</a> <span title="Last edited at&nbsp;2020-04-25">2020-04-25</span></p><p>Một dev còn non :v</p></div><h2 class="post-title">Hướng dẫn xây dựng gRPC server bằng typescript đơn giản</h2><div class="post-meta">emm... 10655 words in the article | you are the&nbsp;<span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>th friend who reading now</div></div><div class="post-content markdown-body"><p>Bài Viết đang được cập nhật</p><p>Dạo này mình là một dự án microservices và có gặp phải các vấn đề về giao tiếp giữa các service trong khối microservices với nhau</p><p>Hẳn chúng ta ai cũng quen làm việc với các REST API. Tuy nhiên, trong môi trường microservice, việc sử dụng REST API để giao tiếp giữa các service sẽ gây ra độ trễ đáng kể. gRPC ra đời để giải quyết vấn đề này. Trong blog này mình sẽ trình bày nội dung cơ bản liên quan đến gRPC và làm một todo list app demo để chúng ta biết cách sử dụng gRPC trong thực tế nhé.</p><h2 id="gRPC-la-gi"><a href="#gRPC-la-gi" class="headerlink" title="gRPC là gì ???"></a>gRPC là gì ???</h2><p>gRPC là một RPC platform được phát triển bởi Google nhằm tối ưu hoá và tăng tốc việc giao tiếp giữa các service với nhau trong kiến trúc microservice.</p><p>gRPC dùng Protocal Buffer giảm kích thước request và response data, RPC để đơn giản hoá trong việc tạo ra các giao tiếp giữa các service với nhau, HTTP/2 để tăng tốc gửi/nhận HTTP request.</p><p>Có thể hiểu nôm na gRPC là tương tự như REST dùng để giao tiếp giữa các service, tuy nhiên tốc độ gRPC nhanh hơn REST rất nhiều, bù lại gRPC khó sử dụng và rườm rà hơn. Bạn chỉ nên sử dụng gRPC khi có vấn đề về độ trễ trong việc giao tiếp giữa các service trong kiến trúc microservice.</p><h3 id="Tai-sao-nen-su-dung-gRPC"><a href="#Tai-sao-nen-su-dung-gRPC" class="headerlink" title="Tại sao nên sử dụng gRPC ???"></a>Tại sao nên sử dụng gRPC ???</h3><p>Vấn đề là gì và tại sao cần nó ?</p><p>RPC có thể được xem là một giao thức request-respone thông thường tuy nhiên nó được dùng cho việc giao tiếp giữa các server với nhau (server-server) nhiều hơn là client-server. Việc này có ý nghĩa rất quan trọng vì trong các hệ thống phân tán (distributed system), application code ở nhiều server hơn là một server. Ví dụ thường thấy nhất chính là kiến trúc Microservices.</p><p>Điều này nghĩa là: một request phía client có thể sẽ phải cần nhiều service chạy trên các server này để tổng hợp thông tin rồi mới response cho client. Sự liên lạc giữa các server lúc này sẽ là vấn đề mà trước đó tất cả service chạy trên 1 server thì khoẻ re, vì local call nên chẳng ngại gì cả. Chính xác là khi đó, khi một server muốn “nói chuyện” với server khác sẽ cần phải encode data (JSON, XML), phía nhận cũng phải làm công việc ngược lại là decode data mới hiểu thằng kia nói gì với mình rôi lại phải encode lại tiếp. Việc này tiêu tốn khá nhiều tài nguyên xử lý (CPU) mà lẽ ra chỉ cần làm ở bước đầu và cuối (đầu nhận và trả về cuối cùng).</p><p>Tối ưu cho việc “giao tiếp” giữa các server là lý do gRPC ra đời.</p><p>Để giải bài toán trên, gRPC đã sử dụng binary để truyền đi thay vì phải encode chúng thành các ngôn ngữ trung gian JSON/XML. Việc này rõ ràng đã làm tăng tốc giao tiếp các servers lên rất nhiều, giảm overhead cho CPUs. Google cũng “tiện tay” làm luôn cả protobuf (protocol buffers), đây là ngôn ngữ mà gRPC dùng như một default serialization format. Implement phần này thật sự phải là tay to lắm nên Google xử dụng protobuf như một script trung gian để generate phần hard core cho các dev ở các ngôn ngữ phổ biến như: C++, C#, Go, Java, Pyhon.</p><p>Thứ giúp gRPC giao tiếp binary ngon vậy chính là http/2, đây vốn là giao thức có rất nhiều cải tiến so với http/1.1. Bản thân http/2 cũng được coi như là sự thay thế cho SPDY, giao thức mà cũng chính Google phát triển, open source vào 2012 và ngừng hỗ trợ vào 2015 (http/2 có implement và thay thế rồi).</p><p><a href="https://viblo.asia/p/grpc-no-la-gi-va-co-nen-su-dung-hay-khong-gDVK2mAj5Lj" target="_blank" rel="noopener external nofollow noreferrer">Tham khảo thêm tại đây</a></p><h2 id="Xay-dung-gRPC-server-bang-Typescript"><a href="#Xay-dung-gRPC-server-bang-Typescript" class="headerlink" title="Xây dựng gRPC server bằng Typescript"></a>Xây dựng gRPC server bằng Typescript</h2><h3 id="Settup-mot-project-Typescript"><a href="#Settup-mot-project-Typescript" class="headerlink" title="Settup một project Typescript"></a>Settup một project Typescript</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir ts-grpc</span><br></pre></td></tr></table></figure><p>Khởi tạo một thư mục trống.</p><p>Và cấu trúc thư mục sẽ có dạng như sau.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── dist/                            <span class="comment"># Compiled files</span></span><br><span class="line">├── src/                             <span class="comment"># Source files</span></span><br><span class="line">│   ├── handlers/                    <span class="comment"># gRPC service handlers</span></span><br><span class="line">|   │   └── greeter.ts               <span class="comment"># Greeter service definitions</span></span><br><span class="line">│   ├── proto/                       <span class="comment"># Proto files</span></span><br><span class="line">│   │   ├── greeter/                 <span class="comment"># Greeter gRPC service</span></span><br><span class="line">│   │   │   └── greeter.proto</span><br><span class="line">│   │   ├── index.ts                 <span class="comment"># Registers all the proto typescript definitions</span></span><br><span class="line">│   └── server.ts                    <span class="comment"># Bootstrap server, add middleware (logs, graphql...)</span></span><br><span class="line">├── scripts/                         <span class="comment"># Generation tools</span></span><br><span class="line">│   └── protoc.sh                    <span class="comment"># Script to generate protoc typescript definitions</span></span><br><span class="line">└── ...</span><br></pre></td></tr></table></figure><p>bây giờ chúng ta tiến hành cài đặt các dependencies cần thiết</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init -y</span><br><span class="line">npm install grpc google-protobuf dotenv</span><br><span class="line">npm install typescript @types/node @types/google-protobuf @types/dotenv --save-dev</span><br></pre></td></tr></table></figure><p>Đây là các package chúng ta cài</p><ul><li>grpc để dùng gRPC với Node.js</li><li>google-protobuf để dùng Protocol Buffers (.proto) với javascript</li><li>dotenv để load các biến môi trường từ file .env</li><li>TypeScript và các gói mở rộng của typescript để dịch các package trên</li></ul><p>Chúng ta sẽ khởi tạo project typescript với lệnh:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx tsc --init</span><br></pre></td></tr></table></figure><p>Sau khi chạy lệnh này xong chúng ta sẽ có file <strong>tsconfig.json</strong> như sau:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"outDir"</span>: <span class="string">"./dist/"</span>,</span><br><span class="line">    <span class="attr">"module"</span>: <span class="string">"commonjs"</span>,</span><br><span class="line">    <span class="attr">"noImplicitAny"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"allowJs"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"esModuleInterop"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"target"</span>: <span class="string">"es6"</span>,</span><br><span class="line">    <span class="attr">"sourceMap"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"include"</span>: [<span class="string">"./src/**/*"</span>],</span><br><span class="line">  <span class="attr">"exclude"</span>: [<span class="string">"node_modules"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bây giờ mở file <strong>greeter.proto</strong> thêm code sau đây</p><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> greeter;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The greeting service definition.</span></span><br><span class="line"><span class="class"><span class="keyword">service</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Sends a greeting</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloResponse)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The request message containing the user's name.</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloRequest</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The response message containing the greetings</span></span><br><span class="line"><span class="class"><span class="keyword">message</span> <span class="title">HelloResponse</span> </span>&#123;</span><br><span class="line">  <span class="built_in">string</span> <span class="class"><span class="keyword">message</span> = 1;</span></span><br><span class="line"><span class="class">&#125;</span></span><br></pre></td></tr></table></figure><p>Nó sẽ tạo ra một service SayHello có kiểu dữ liệu request là HelloRequest với một trường dữ liệu là name và trả về một response với kiểu dữ liệu là HelloResponse. Bạn có thể xem thêm cú pháp syntax về proto 3 tại đây <a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="noopener external nofollow noreferrer">https://developers.google.com/protocol-buffers/docs/proto</a>.</p><h3 id="Generating-TypeScript-definitions"><a href="#Generating-TypeScript-definitions" class="headerlink" title="Generating TypeScript definitions"></a>Generating TypeScript definitions</h3><p>Bây giờ chúng ta sẽ tạo ra các TypeScript definitions hỗ trợ cho gRPC service được khai báo trong file proto. Chúng ta sẽ tiến hành dịch file <strong>greeter.proto</strong> thành các class typescript có thể hiểu và sử dụng.</p><p>Chúng ta sẽ cài thêm các dependencies:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install grpc-tools grpc_tools_node_protoc_ts --save-dev</span><br></pre></td></tr></table></figure><p>Here we installed few more dev dependencies</p><ul><li>grpc-tools tạo javascript files cho proto files</li><li>grpc_tools_node_protoc_ts tạo các file module typescript tương ứng d.ts</li></ul><p>Sau khi cài các package xong, chúng ta sẽ tiến hành viết bash script để dịch file src/proto/.proto. Mở file <strong>protoc.sh</strong> và thêm code sau.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">BASEDIR=$(dirname <span class="string">"<span class="variable">$0</span>"</span>)</span><br><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$&#123;BASEDIR&#125;</span>"</span>/../</span><br><span class="line"></span><br><span class="line">PROTOC_GEN_TS_PATH=<span class="string">"./node_modules/.bin/protoc-gen-ts"</span></span><br><span class="line">GRPC_TOOLS_NODE_PROTOC_PLUGIN=<span class="string">"./node_modules/.bin/grpc_tools_node_protoc_plugin"</span></span><br><span class="line">GRPC_TOOLS_NODE_PROTOC=<span class="string">"./node_modules/.bin/grpc_tools_node_protoc"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> ./src/proto/*; <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># skip the non proto files</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$(basename "$f")</span>"</span> == <span class="string">"index.ts"</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># loop over all the available proto files and compile them into respective dir</span></span><br><span class="line">  <span class="comment"># JavaScript code generating</span></span><br><span class="line">  <span class="variable">$&#123;GRPC_TOOLS_NODE_PROTOC&#125;</span> \</span><br><span class="line">      --js_out=import_style=commonjs,binary:<span class="string">"<span class="variable">$&#123;f&#125;</span>"</span> \</span><br><span class="line">      --grpc_out=<span class="string">"<span class="variable">$&#123;f&#125;</span>"</span> \</span><br><span class="line">      --plugin=protoc-gen-grpc=<span class="string">"<span class="variable">$&#123;GRPC_TOOLS_NODE_PROTOC_PLUGIN&#125;</span>"</span> \</span><br><span class="line">      -I <span class="string">"<span class="variable">$&#123;f&#125;</span>"</span> \</span><br><span class="line">      <span class="string">"<span class="variable">$&#123;f&#125;</span>"</span>/*.proto</span><br><span class="line"></span><br><span class="line">  <span class="variable">$&#123;GRPC_TOOLS_NODE_PROTOC&#125;</span> \</span><br><span class="line">      --plugin=protoc-gen-ts=<span class="string">"<span class="variable">$&#123;PROTOC_GEN_TS_PATH&#125;</span>"</span> \</span><br><span class="line">      --ts_out=<span class="string">"<span class="variable">$&#123;f&#125;</span>"</span> \</span><br><span class="line">      -I <span class="string">"<span class="variable">$&#123;f&#125;</span>"</span> \</span><br><span class="line">      <span class="string">"<span class="variable">$&#123;f&#125;</span>"</span>/*.proto</span><br><span class="line"></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>Phân quyền cho file <strong>protoc.sh</strong> bằng lệnh sau.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x ./scripts/protoc.sh</span><br></pre></td></tr></table></figure><p>Bây giờ chạy script trên và nó sẽ tao các javascript file trong src/proto/greeter. Mỗi khi chỉnh sửa proto file bạn hãy nhớ chạy lại lệnh này để update các javascript file.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./scripts/protoc.sh</span><br></pre></td></tr></table></figure><p>Sau đó mở file <strong>src/proto/index.ts</strong> và thêm code sau</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./greeter/greeter_pb'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./greeter/greeter_grpc_pb'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> protoIndex: any = (): <span class="function"><span class="params">void</span> =&gt;</span> &#123;&#125;;</span><br></pre></td></tr></table></figure><p>Nhớ là bạn luôn phải update file này khi tạo ra các proto file mới .</p><h3 id="Tao-handlers"><a href="#Tao-handlers" class="headerlink" title="Tạo handlers"></a>Tạo handlers</h3><p>Chúng ta sẽ viết hàm xử lý cho SayHello service, hãy mở src/handlers/greeter.ts thêm code này.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> grpc <span class="keyword">from</span> <span class="string">'grpc'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; HelloRequest, HelloResponse &#125; <span class="keyword">from</span> <span class="string">'./proto/greeter/greeter_pb'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  GreeterService,</span><br><span class="line">  IGreeterServer,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./proto/greeter/greeter_grpc_pb'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreeterHandler</span> <span class="title">implements</span> <span class="title">IGreeterServer</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">_ Greet the user nicely</span></span><br><span class="line"><span class="comment">_ <span class="doctag">@param <span class="variable">call</span></span></span></span><br><span class="line"><span class="comment">_ <span class="doctag">@param <span class="variable">callback</span></span></span></span><br><span class="line"><span class="comment">_</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  sayHello = (</span><br><span class="line">    call: grpc.ServerUnaryCall&lt;HelloRequest&gt;,</span><br><span class="line">    callback: grpc.sendUnaryData&lt;HelloResponse&gt;</span><br><span class="line">  ): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> reply: HelloResponse = <span class="keyword">new</span> HelloResponse();</span><br><span class="line"></span><br><span class="line">    reply.setMessage(<span class="string">`Hello, <span class="subst">$&#123;call.request.getName()&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">    callback(<span class="literal">null</span>, reply);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  service: GreeterService, <span class="comment">// Service interface</span></span><br><span class="line">  handler: <span class="keyword">new</span> GreeterHandler(), <span class="comment">// Service interface definitions</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>chúng ta sẽ thấy method sayHello được implement SayHello rpc service. lấy dữ liệu name từ request HelloRequest và chuyễn thành một câu chào kiểu HelloResponse và trả về</p><h3 id="Khoi-tao-server"><a href="#Khoi-tao-server" class="headerlink" title="Khởi tạo server"></a>Khởi tạo server</h3><p>Bây giờ chúng ta sẽ khởi tạo gRPC server. Mở file src/server.ts và thêm code:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dotenv/config'</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> grpc <span class="keyword">from</span> <span class="string">'grpc'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; protoIndex &#125; <span class="keyword">from</span> <span class="string">'./proto'</span>;</span><br><span class="line"><span class="keyword">import</span> greeterHandler <span class="keyword">from</span> <span class="string">'./handlers/greeter'</span>;</span><br><span class="line"></span><br><span class="line">protoIndex();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port: string | number = process.env.PORT || <span class="number">50051</span>;</span><br><span class="line"></span><br><span class="line">type StartServerType = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> startServer: StartServerType = (): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// create a new gRPC server</span></span><br><span class="line">  <span class="keyword">const</span> server: grpc.Server = <span class="keyword">new</span> grpc.Server();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register all the handler here...</span></span><br><span class="line">  server.addService(greeterHandler.service, greeterHandler.handler);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// define the host/port for server</span></span><br><span class="line">  server.bindAsync(</span><br><span class="line">    <span class="string">`0.0.0.0:<span class="subst">$&#123;port&#125;</span>`</span>,</span><br><span class="line">    grpc.ServerCredentials.createInsecure(),</span><br><span class="line">    (err: <span class="built_in">Error</span>, <span class="attr">port</span>: number) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">console</span>.error(err);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`gRPC listening on <span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// start the gRPC server</span></span><br><span class="line">  server.start();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">startServer();</span><br></pre></td></tr></table></figure><p>Ok, chúng ta đã tạo ra các instance của greeter service, đăng ký greeter service handler và chạy server.</p><h3 id="Kiem-tra-xem-nao"><a href="#Kiem-tra-xem-nao" class="headerlink" title="Kiểm tra xem nào"></a>Kiểm tra xem nào</h3><p>Trước tiên mở file <strong>package.json</strong> thêm các lệnh sau vào phần script:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">"scripts": &#123;</span><br><span class="line">    "build": "npx tsc --skipLibCheck",</span><br><span class="line">    "start": "npx tsc --skipLibCheck &amp;&amp; node ./dist/server.js"</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Ok chạy thử nào!!!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br><span class="line">npm run start</span><br></pre></td></tr></table></figure><p>Ok bây giờ chúng ta có một server gRPC chạy trên port 50051</p><p>Để test gRPC các bạn hãy dùng <strong>BloomRPC</strong> Đây là một GUI tương tữ như <strong>Postman</strong> nhưng dùng cho các api bằng gRPC. Để cài đặt các bạn xem hướng dẫn <a href="https://github.com/uw-labs/bloomrpc" target="_blank" rel="noopener external nofollow noreferrer">tại đây</a>.</p><p><img src="https://i.imgur.com/bsvIC1U.png" alt=""></p><p>OK để test chúng ta hãy bắt đầu làm như sau, import greeter.proto file, đổi URL thành 127.0.0.1:50051 và click vào icon play để tận hưởng =]]]] chúc các bạn thành công.</p></div><div class="post-tool"></div><div class="post-tags">Tags： <a href="/tags/gRPC/">gRPC</a> <a href="/tags/TypeScript/">TypeScript</a></div></article><p style="text-align:center">This article just represents my own viewpoint. If there is something wrong, please correct me.</p><section id="comments"><div class="fb-comments" data-href="
https://ntpntp1997.github.io/Huong-dan-xay-dung-gRPC-server-bang-typescript-don-gian/" data-numposts="10"></div></section></div><script src="/js/busuanzi.pure.mini.js"></script></div></div><footer class="footer"><div class="footer-inner" style="text-align:center"><p><a href="/about" title="About">About</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp <a href="/help" title="Help">Help</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp <a href="/links" title="Links">Links</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp <a href="/sitemap.xml" title="SiteMap">SiteMap</a></p><p>Has been established&nbsp<a href="/timeline" id="siteBuildingTime"></a>&nbspDays，<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="licence external nofollow noreferrer">Based on Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a><br>©2017-<span id="cpYear"></span> Based on&nbsp<a href="http://hexo.io" target="_blank" rel="nofollow">Hexo</a> ，Theme by&nbsp&nbsp<a href="https://github.com/tangkunyin/hexo-theme-jsimple" target="_blank" rel="bookmark external nofollow noreferrer">JSimple</a> ，Author&nbsp<a href="/" target="_blank" rel="friend">Thanh Phương</a> ，Hosted by <a href="https://pages.github.com/" target="_blank" rel="nofollow">GitHub Pages</a></p></div></footer><script src="/js/SimpleCore.js"></script></div><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input id="local-search-input" spellcheck="false" type="text" autocomplete="off" placeholder="Input query keywords here..."></div></div><div id="local-search-result"></div></div><div class="fixed-btn"><a class="btn-gotop" href="javascript:" rel="external nofollow noreferrer"><i class="fa fa-angle-up"></i></a></div><script>$(function(){var a={buildingTime:"01/20/2018",current:0<$(".post-tags").length?"post":"archive",localSearch:{dbPath:""},readMode:"day",localSearch:{dbPath:"/search.json",trigger:"auto",topN:"1",unescape:"false"}};SimpleCore.init(a)})</script><script>(function(w,d, s, id) {w.webpushr=w.webpushr||function(){(w.webpushr.q=w.webpushr.q||[]).push(arguments)};var js, fjs = d.getElementsByTagName(s)[0];js = d.createElement(s); js.id = id;js.src = 'https://cdn.webpushr.com/app.min.js';fjs.parentNode.appendChild(js);}(window,document, 'script', 'webpushr-jssdk'));webpushr('init','BGIF-nevndimBG_qolCIfvKkPCEB1lX8orFiANy1SyN09kDtwmdEb_zer0UqBSwRWcCoWjOM7ObLl6zMqXl58YA');</script></body></html>